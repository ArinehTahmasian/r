---
# Please do not edit this file directly; it is auto generated.
# Instead, please edit 11-Data-Verbs---mutate.md in _episodes_rmd/
title: Creating New Variables
teaching: 30
exercises: 15
questions:
  - "How can I create new variables in my data frame?"
  - "How do I deal with a data frame made up of different groups?"
objectives:
  - "Create new columns by performing calculations on old variables."
  - "Use functions to create new variables."
keypoints:
  - "Use `mutate()` to create new variables from old ones."
  - "You can create new variables using any function that returns a vector of the same length as the data frame."
  - "Use `group_by()` to group your data based on a variable."
source: Rmd
---



So far, we have been looking at functions that deal just with the variables in our data frame. But
what if we are needing to create *new* variables? For that task, we will use the `mutate()` function
from the [dplyr](https://dplyr.tidyverse.org) package of the tidyverse.

To create a new variable, you provide `mutate()` with the name of the new column and how to calculate
the new value

~~~
mutate(gapminder, gdp = gdpPercap * pop)
~~~
{: .language-r}



~~~
# A tibble: 1,704 x 7
   country     continent  year lifeExp      pop gdpPercap          gdp
   <chr>       <chr>     <dbl>   <dbl>    <dbl>     <dbl>        <dbl>
 1 Afghanistan Asia       1952    28.8  8425333      779.  6567086330.
 2 Afghanistan Asia       1957    30.3  9240934      821.  7585448670.
 3 Afghanistan Asia       1962    32.0 10267083      853.  8758855797.
 4 Afghanistan Asia       1967    34.0 11537966      836.  9648014150.
 5 Afghanistan Asia       1972    36.1 13079460      740.  9678553274.
 6 Afghanistan Asia       1977    38.4 14880372      786. 11697659231.
 7 Afghanistan Asia       1982    39.9 12881816      978. 12598563401.
 8 Afghanistan Asia       1987    40.8 13867957      852. 11820990309.
 9 Afghanistan Asia       1992    41.7 16317921      649. 10595901589.
10 Afghanistan Asia       1997    41.8 22227415      635. 14121995875.
# … with 1,694 more rows
~~~
{: .output}

This line adds a new column to our gapminder data called `gdp` and the value in this column is 
calculated by multiplying the `gdpPercap` and the `pop` figure for each row.

You are not limited to mathematical operators in creating new columns. Any function that produces a
value for each row can be used:


~~~
# Take the logarithm of the population value
mutate(gapminder, log_pop = log(pop))
~~~
{: .language-r}



~~~
# A tibble: 1,704 x 7
   country     continent  year lifeExp      pop gdpPercap log_pop
   <chr>       <chr>     <dbl>   <dbl>    <dbl>     <dbl>   <dbl>
 1 Afghanistan Asia       1952    28.8  8425333      779.    15.9
 2 Afghanistan Asia       1957    30.3  9240934      821.    16.0
 3 Afghanistan Asia       1962    32.0 10267083      853.    16.1
 4 Afghanistan Asia       1967    34.0 11537966      836.    16.3
 5 Afghanistan Asia       1972    36.1 13079460      740.    16.4
 6 Afghanistan Asia       1977    38.4 14880372      786.    16.5
 7 Afghanistan Asia       1982    39.9 12881816      978.    16.4
 8 Afghanistan Asia       1987    40.8 13867957      852.    16.4
 9 Afghanistan Asia       1992    41.7 16317921      649.    16.6
10 Afghanistan Asia       1997    41.8 22227415      635.    16.9
# … with 1,694 more rows
~~~
{: .output}



~~~
# Abbreviate the country name
# str_sub() takes a subset of a string from the given coordinates
mutate(gapminder, country_abbr = str_sub(country, start = 1, end = 4))
~~~
{: .language-r}



~~~
# A tibble: 1,704 x 7
   country     continent  year lifeExp      pop gdpPercap country_abbr
   <chr>       <chr>     <dbl>   <dbl>    <dbl>     <dbl> <chr>       
 1 Afghanistan Asia       1952    28.8  8425333      779. Afgh        
 2 Afghanistan Asia       1957    30.3  9240934      821. Afgh        
 3 Afghanistan Asia       1962    32.0 10267083      853. Afgh        
 4 Afghanistan Asia       1967    34.0 11537966      836. Afgh        
 5 Afghanistan Asia       1972    36.1 13079460      740. Afgh        
 6 Afghanistan Asia       1977    38.4 14880372      786. Afgh        
 7 Afghanistan Asia       1982    39.9 12881816      978. Afgh        
 8 Afghanistan Asia       1987    40.8 13867957      852. Afgh        
 9 Afghanistan Asia       1992    41.7 16317921      649. Afgh        
10 Afghanistan Asia       1997    41.8 22227415      635. Afgh        
# … with 1,694 more rows
~~~
{: .output}

## Chaining mutates
One useful feature is that you can refer to your created columns later on in the same
`mutate()` call.


~~~
gapminder %>% 
  mutate(
    gdp = gdpPercap * pop,
    log_gdp = log(gdp)
  )
~~~
{: .language-r}



~~~
# A tibble: 1,704 x 8
   country    continent  year lifeExp      pop gdpPercap        gdp log_gdp
   <chr>      <chr>     <dbl>   <dbl>    <dbl>     <dbl>      <dbl>   <dbl>
 1 Afghanist… Asia       1952    28.8  8425333      779.    6.57e 9    22.6
 2 Afghanist… Asia       1957    30.3  9240934      821.    7.59e 9    22.7
 3 Afghanist… Asia       1962    32.0 10267083      853.    8.76e 9    22.9
 4 Afghanist… Asia       1967    34.0 11537966      836.    9.65e 9    23.0
 5 Afghanist… Asia       1972    36.1 13079460      740.    9.68e 9    23.0
 6 Afghanist… Asia       1977    38.4 14880372      786.    1.17e10    23.2
 7 Afghanist… Asia       1982    39.9 12881816      978.    1.26e10    23.3
 8 Afghanist… Asia       1987    40.8 13867957      852.    1.18e10    23.2
 9 Afghanist… Asia       1992    41.7 16317921      649.    1.06e10    23.1
10 Afghanist… Asia       1997    41.8 22227415      635.    1.41e10    23.4
# … with 1,694 more rows
~~~
{: .output}


> ## Challenge 1
> Create a column in the gapminder data showing the life expectancy in days and one for GDP in billions
> of dollars
> > ## Solution to Challenge 1
> > 
> > ~~~
> > gapminder %>% 
> >   mutate(
> >     life_exp_days = lifeExp * 365,
> >     gdp_billion = gdpPercap * pop / 10^9
> > )
> > ~~~
> > {: .language-r}
> > 
> > 
> > 
> > ~~~
> > # A tibble: 1,704 x 8
> >    country continent  year lifeExp    pop gdpPercap life_exp_days
> >    <chr>   <chr>     <dbl>   <dbl>  <dbl>     <dbl>         <dbl>
> >  1 Afghan… Asia       1952    28.8 8.43e6      779.        10512.
> >  2 Afghan… Asia       1957    30.3 9.24e6      821.        11071.
> >  3 Afghan… Asia       1962    32.0 1.03e7      853.        11679.
> >  4 Afghan… Asia       1967    34.0 1.15e7      836.        12417.
> >  5 Afghan… Asia       1972    36.1 1.31e7      740.        13172.
> >  6 Afghan… Asia       1977    38.4 1.49e7      786.        14030.
> >  7 Afghan… Asia       1982    39.9 1.29e7      978.        14547.
> >  8 Afghan… Asia       1987    40.8 1.39e7      852.        14900.
> >  9 Afghan… Asia       1992    41.7 1.63e7      649.        15211.
> > 10 Afghan… Asia       1997    41.8 2.22e7      635.        15243.
> > # … with 1,694 more rows, and 1 more variable: gdp_billion <dbl>
> > ~~~
> > {: .output}
> {: .solution}
{: .challenge}

## Variable creation functions
As mentioned before, any function that can take a vector of inputs and return a vector with the same 
length as an output can be used in a `mutate()` call. There are many R functions that can be used
in this situation, and `dplyr` introduces a number of new functions that may be useful for creating 
new variables. Some functions that you might find useful are:

#### Ranking functions
`min_rank()` ranks values in order from lowest to highest.

~~~
mutate(gapminder, life_exp_rank = min_rank(lifeExp))
~~~
{: .language-r}



~~~
# A tibble: 1,704 x 7
   country     continent  year lifeExp      pop gdpPercap life_exp_rank
   <chr>       <chr>     <dbl>   <dbl>    <dbl>     <dbl>         <int>
 1 Afghanistan Asia       1952    28.8  8425333      779.             2
 2 Afghanistan Asia       1957    30.3  9240934      821.             6
 3 Afghanistan Asia       1962    32.0 10267083      853.            11
 4 Afghanistan Asia       1967    34.0 11537966      836.            25
 5 Afghanistan Asia       1972    36.1 13079460      740.            45
 6 Afghanistan Asia       1977    38.4 14880372      786.            83
 7 Afghanistan Asia       1982    39.9 12881816      978.           115
 8 Afghanistan Asia       1987    40.8 13867957      852.           153
 9 Afghanistan Asia       1992    41.7 16317921      649.           173
10 Afghanistan Asia       1997    41.8 22227415      635.           177
# … with 1,694 more rows
~~~
{: .output}

To rank highest to lowest, you can use `desc()` on the variable to rank in `desc`ending order.

~~~
mutate(gapminder, life_exp_rank = min_rank(desc(lifeExp)))
~~~
{: .language-r}



~~~
# A tibble: 1,704 x 7
   country     continent  year lifeExp      pop gdpPercap life_exp_rank
   <chr>       <chr>     <dbl>   <dbl>    <dbl>     <dbl>         <int>
 1 Afghanistan Asia       1952    28.8  8425333      779.          1703
 2 Afghanistan Asia       1957    30.3  9240934      821.          1699
 3 Afghanistan Asia       1962    32.0 10267083      853.          1694
 4 Afghanistan Asia       1967    34.0 11537966      836.          1680
 5 Afghanistan Asia       1972    36.1 13079460      740.          1660
 6 Afghanistan Asia       1977    38.4 14880372      786.          1622
 7 Afghanistan Asia       1982    39.9 12881816      978.          1590
 8 Afghanistan Asia       1987    40.8 13867957      852.          1552
 9 Afghanistan Asia       1992    41.7 16317921      649.          1532
10 Afghanistan Asia       1997    41.8 22227415      635.          1528
# … with 1,694 more rows
~~~
{: .output}

#### Offset functions
To calculate differences between observations, you may be wanting to look at the value immediately
before or after it. These can be accessed using `lag()` or `lead()` respectively.

~~~
mutate(gapminder, life_exp_prev = lag(lifeExp), life_exp_next = lead(lifeExp))
~~~
{: .language-r}



~~~
# A tibble: 1,704 x 8
   country continent  year lifeExp    pop gdpPercap life_exp_prev
   <chr>   <chr>     <dbl>   <dbl>  <dbl>     <dbl>         <dbl>
 1 Afghan… Asia       1952    28.8 8.43e6      779.          NA  
 2 Afghan… Asia       1957    30.3 9.24e6      821.          28.8
 3 Afghan… Asia       1962    32.0 1.03e7      853.          30.3
 4 Afghan… Asia       1967    34.0 1.15e7      836.          32.0
 5 Afghan… Asia       1972    36.1 1.31e7      740.          34.0
 6 Afghan… Asia       1977    38.4 1.49e7      786.          36.1
 7 Afghan… Asia       1982    39.9 1.29e7      978.          38.4
 8 Afghan… Asia       1987    40.8 1.39e7      852.          39.9
 9 Afghan… Asia       1992    41.7 1.63e7      649.          40.8
10 Afghan… Asia       1997    41.8 2.22e7      635.          41.7
# … with 1,694 more rows, and 1 more variable: life_exp_next <dbl>
~~~
{: .output}

#### Cumulative computations
Cumulative sums (`cumsum()`), products (`cumprod()`) and means (`cummean()`) are all available to 
provide running computation of a variable. While not particularly useful for the gapminder data,
you can get an idea of how they function:


~~~
mutate(gapminder, cumulative_life_exp = cumsum(lifeExp))
~~~
{: .language-r}



~~~
# A tibble: 1,704 x 7
   country     continent  year lifeExp     pop gdpPercap cumulative_life_e…
   <chr>       <chr>     <dbl>   <dbl>   <dbl>     <dbl>              <dbl>
 1 Afghanistan Asia       1952    28.8  8.43e6      779.               28.8
 2 Afghanistan Asia       1957    30.3  9.24e6      821.               59.1
 3 Afghanistan Asia       1962    32.0  1.03e7      853.               91.1
 4 Afghanistan Asia       1967    34.0  1.15e7      836.              125. 
 5 Afghanistan Asia       1972    36.1  1.31e7      740.              161. 
 6 Afghanistan Asia       1977    38.4  1.49e7      786.              200. 
 7 Afghanistan Asia       1982    39.9  1.29e7      978.              240. 
 8 Afghanistan Asia       1987    40.8  1.39e7      852.              280. 
 9 Afghanistan Asia       1992    41.7  1.63e7      649.              322. 
10 Afghanistan Asia       1997    41.8  2.22e7      635.              364. 
# … with 1,694 more rows
~~~
{: .output}

> ## Challenge 2
> Using an offset function, create a column showing the **change** in life expectancy between each sample period. Do any 
> countries have no change in life expectancy for a period?
> > ## Solution to Challenge 2
> > 
> > ~~~
> > gapminder %>% 
> >   mutate(life_exp_change = lifeExp - lag(lifeExp)) %>% 
> >   filter(life_exp_change == 0)
> > ~~~
> > {: .language-r}
> > 
> > 
> > 
> > ~~~
> > # A tibble: 1 x 7
> >   country continent  year lifeExp      pop gdpPercap life_exp_change
> >   <chr>   <chr>     <dbl>   <dbl>    <dbl>     <dbl>           <dbl>
> > 1 Romania Europe     1967    66.8 19284814     6471.               0
> > ~~~
> > {: .output}
> {: .solution}
{: .challenge}

> ## Challenge 3
> Look more carefully at the output from your previous solution. Is the life expectancy change you
> are calculating correct in every row? 
> > ## Hint
> > What is going on between rows 11 and 14?
> {: .solution}
> > ## Solution to Challenge 3
> > 
> > ~~~
> > mutated_data <- gapminder %>% 
> >   mutate(life_exp_change = lifeExp - lag(lifeExp))
> > 
> > mutated_data[11:14, ]
> > ~~~
> > {: .language-r}
> > 
> > 
> > 
> > ~~~
> > # A tibble: 4 x 7
> >   country     continent  year lifeExp      pop gdpPercap life_exp_change
> >   <chr>       <chr>     <dbl>   <dbl>    <dbl>     <dbl>           <dbl>
> > 1 Afghanistan Asia       2002    42.1 25268405      727.           0.366
> > 2 Afghanistan Asia       2007    43.8 31889923      975.           1.70 
> > 3 Albania     Europe     1952    55.2  1282697     1601.          11.4  
> > 4 Albania     Europe     1957    59.3  1476505     1942.           4.05 
> > ~~~
> > {: .output}
> > In row 13 the data switches from Afghanistan to Albania, so the new column is calculated as
> > Albania's life expectancy in 1952 minus Afghanistan's life expectancy in 2007. The calculated
> > value is therefore not comparable to the rest of the measurements.
> {: .solution}
{: .challenge}

## Operating on groups
The problem identified above is that the `lag()` function doesn't know that at some point the data 
changes country, and that it is not sensible to look at the previous value if it is from a different
country. To fix this problem, we can use `group_by()`


~~~
gapminder %>% 
  group_by(country)
~~~
{: .language-r}



~~~
# A tibble: 1,704 x 6
# Groups:   country [142]
   country     continent  year lifeExp      pop gdpPercap
   <chr>       <chr>     <dbl>   <dbl>    <dbl>     <dbl>
 1 Afghanistan Asia       1952    28.8  8425333      779.
 2 Afghanistan Asia       1957    30.3  9240934      821.
 3 Afghanistan Asia       1962    32.0 10267083      853.
 4 Afghanistan Asia       1967    34.0 11537966      836.
 5 Afghanistan Asia       1972    36.1 13079460      740.
 6 Afghanistan Asia       1977    38.4 14880372      786.
 7 Afghanistan Asia       1982    39.9 12881816      978.
 8 Afghanistan Asia       1987    40.8 13867957      852.
 9 Afghanistan Asia       1992    41.7 16317921      649.
10 Afghanistan Asia       1997    41.8 22227415      635.
# … with 1,694 more rows
~~~
{: .output}

It might not look like much has changed here, but notice the `Groups:   country [142]` in the second
line. This is telling us that the gapminder dataset is now grouped by country (and that there are
142 groups in the data frame). Rather than one large data frame, this can be thought of as 142 
separate data frames that all have the same column structure and just happen to be stacked on top
of each other.

When you use one of the data manipulation functions we have looked at on a *grouped* data frame, it
will apply the function separately for each group.

> ## Challenge 4
> Repeat Challenge 3, but try to fix the problem you identified by grouping the data frame first.
> > ## Solution to Challenge 4
> > 
> > ~~~
> > mutated_by_group <- gapminder %>% 
> >   group_by(country) %>% 
> >   mutate(life_exp_change = lifeExp - lag(lifeExp))
> >   
> > mutated_by_group[11:14, ]
> > ~~~
> > {: .language-r}
> > 
> > 
> > 
> > ~~~
> > # A tibble: 4 x 7
> > # Groups:   country [2]
> >   country     continent  year lifeExp      pop gdpPercap life_exp_change
> >   <chr>       <chr>     <dbl>   <dbl>    <dbl>     <dbl>           <dbl>
> > 1 Afghanistan Asia       2002    42.1 25268405      727.           0.366
> > 2 Afghanistan Asia       2007    43.8 31889923      975.           1.70 
> > 3 Albania     Europe     1952    55.2  1282697     1601.          NA    
> > 4 Albania     Europe     1957    59.3  1476505     1942.           4.05 
> > ~~~
> > {: .output}
> {: .solution}
{: .challenge}
